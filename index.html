<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viswam Edutech Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --text: #333; --white: #fff; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        .container { max-width: 1100px; margin: 0 auto; }

        /* HEADER */
        .header { background: var(--white); padding: 15px 30px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; border-bottom: 4px solid var(--accent); }
        .header img { max-height: 60px; }
        .header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }

        /* CARDS & INPUTS */
        .card { background: var(--white); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; margin-bottom: 10px; }
        
        /* BUTTONS */
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        /* REVIEW TABLE */
        .review-list { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; margin-top: 15px; }
        .review-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; background: #fff; }
        .review-item:nth-child(even) { background: #f9f9f9; }
        .review-item button { margin-left: 10px; }

        /* TABS */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        
        /* EXAM TIMER */
        .timer-float { position: sticky; top: 10px; background: #2c3e50; color: #fff; padding: 10px 20px; border-radius: 30px; text-align: center; font-weight: bold; z-index: 100; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="header no-print">
        <img src="iitneet.png" alt="Logo L" onerror="this.style.display='none'">
        <div style="text-align:center">
            <h1>Viswam Edutech Portal</h1>
            <small>Secure Examination System</small>
        </div>
        <img src="viswam.png" alt="Logo R" onerror="this.style.display='none'">
    </div>

    <div id="viewLogin" class="container" style="max-width: 400px;">
        <div class="card">
            <h2 style="text-align:center; color:var(--primary);">Login</h2>
            <form onsubmit="handleLogin(event)">
                <label>User ID</label>
                <input type="text" id="loginUser" placeholder="admin / S101" required>
                <label>Password</label>
                <input type="password" id="loginPass" placeholder="Password" required>
                
                <div id="studentFilters">
                    <label>Class</label><input type="text" id="loginClass" placeholder="e.g. 10th">
                    <label>Subject</label><input type="text" id="loginSubj" placeholder="e.g. Maths">
                </div>
                <button type="submit" class="btn-primary" style="width:100%">Login</button>
            </form>
            <p id="loginMsg" style="color:red; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="viewAdmin" class="container hidden">
        <div class="nav-tabs">
            <button class="btn-primary" onclick="switchTab('create')">Build Exam</button>
            <button class="btn-primary" onclick="switchTab('students')">Students</button>
            <button class="btn-primary" onclick="switchTab('results')">Results</button>
            <button class="btn-danger" onclick="location.reload()">Logout</button>
        </div>

        <div id="tabCreate" class="hidden">
            
            <div class="card">
                <h3>1. Question Bank</h3>
                <div style="display:flex; gap:10px; align-items: center;">
                    <input type="file" accept=".json" id="fileImport">
                    <button class="btn-accent" onclick="bulkImport()">Import JSON</button>
                    <button class="btn-primary" onclick="document.getElementById('manualEntry').classList.toggle('hidden')">Add Manual Question</button>
                </div>
                
                <div id="manualEntry" class="hidden" style="margin-top:10px; padding:10px; border:1px dashed #ccc;">
                    <textarea id="qText" placeholder="Question Text..." rows="2"></textarea>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                        <input type="text" id="optA" placeholder="Option A"> <input type="text" id="optB" placeholder="Option B">
                        <input type="text" id="optC" placeholder="Option C"> <input type="text" id="optD" placeholder="Option D">
                    </div>
                    <select id="qCorrect"><option value="A">Answer A</option><option value="B">Answer B</option><option value="C">Answer C</option><option value="D">Answer D</option></select>
                    <button class="btn-success btn-sm" onclick="addQuestion()">Save to Bank</button>
                </div>
            </div>

            <div class="card" style="background: #eef2f3; border-left: 5px solid var(--accent);">
                <h3>2. Draft & Review Paper</h3>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
                    <input type="text" id="draftSubj" placeholder="Subject (e.g. Maths)">
                    <input type="text" id="draftClass" placeholder="Class (e.g. 10th)">
                    <input type="number" id="draftTime" placeholder="Mins" value="30">
                    <input type="number" id="draftLimit" placeholder="Count (e.g. 50)">
                </div>
                <button class="btn-accent" onclick="generateDraft()">Generate Draft</button>
                
                <div id="reviewContainer" class="hidden">
                    <h4 style="margin:15px 0 5px 0;">Paper Review (<span id="draftCount">0</span> Questions)</h4>
                    <p style="font-size:0.8rem; color:#666;">Check questions below. Click 'Remove' to delete specific ones.</p>
                    
                    <div id="draftList" class="review-list"></div>
                    
                    <br>
                    <button class="btn-success" style="width:100%; padding:15px; font-size:1.1rem;" onclick="publishFinal()">✅ CONFIRM & PUBLISH EXAM</button>
                </div>
            </div>
        </div>

        <div id="tabStudents" class="hidden">
            <div class="card">
                <h3>Register Student</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="newUid" placeholder="Student ID">
                    <input type="password" id="newPass" placeholder="Password">
                    <button class="btn-success" onclick="addStudent()">Add</button>
                </div>
                <div id="studentList" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="tabResults" class="hidden">
            <div class="card">
                <h3>Exam Results</h3>
                <table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#eee; text-align:left;"><th>Student</th><th>Subject</th><th>Score</th><th>Time</th></tr></thead>
                    <tbody id="resultList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="viewPreview" class="container hidden" style="text-align:center;">
        <div class="card">
            <h1 id="preTitle" style="color:var(--primary)">Exam Ready</h1>
            <p id="preMeta" style="font-size:1.2rem; margin-bottom:20px;">--</p>
            <button class="btn-success" onclick="startExam()" style="font-size:1.2rem; padding:15px; width:200px;">START</button>
        </div>
    </div>

    <div id="viewExam" class="container hidden">
        <div id="examTimer" class="timer-float">Time Left: --:--</div>
        <div id="examContainer"></div>
        <br>
        <button class="btn-success" style="width:100%; padding:15px;" onclick="submitExam()">SUBMIT PAPER</button>
    </div>

    <script>
        const API = '/api';
        let userCtx = {}; 
        let currentDraft = []; // Stores questions currently being reviewed
        let examData = {}; 
        let activeQs = [];
        let timerInt;

        // --- AUTH ---
        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;

            if(u.toLowerCase() === 'admin' && p === 'Viswam@2026') {
                showView('viewAdmin'); switchTab('create'); return;
            }

            const cls = document.getElementById('loginClass').value;
            const subj = document.getElementById('loginSubj').value;
            if(!cls || !subj) { alert("Enter Class & Subject"); return; }

            try {
                const res = await fetch(API + '/users');
                const users = await res.json();
                const valid = users.find(x => x.username === u && x.password === p);
                if(valid) {
                    userCtx = { ...valid, class: cls, subject: subj };
                    findPaper(cls, subj);
                } else { document.getElementById('loginMsg').innerText = "Invalid Login"; }
            } catch(e) { alert("Server Offline"); }
        }
        
        document.getElementById('loginUser').addEventListener('input', (e) => {
            document.getElementById('studentFilters').style.display = e.target.value.toLowerCase() === 'admin' ? 'none' : 'block';
        });

        // --- DRAFTING & REVIEW LOGIC (NEW) ---
        async function generateDraft() {
            const limit = parseInt(document.getElementById('draftLimit').value) || 0;
            const subjFilter = document.getElementById('draftSubj').value.trim();

            const bank = await (await fetch(API + '/bank')).json();
            if(bank.length === 0) { alert("Bank is empty!"); return; }

            // 1. Filter by Subject (if typed)
            let filtered = bank;
            if(subjFilter) {
                filtered = bank.filter(q => q.subject && q.subject.toLowerCase().includes(subjFilter.toLowerCase()));
            }

            if(filtered.length === 0) { alert(`No questions found for subject: ${subjFilter}`); return; }

            // 2. Randomize & Limit
            currentDraft = filtered.sort(() => Math.random() - 0.5);
            if(limit > 0 && currentDraft.length > limit) {
                currentDraft = currentDraft.slice(0, limit);
            }

            renderReview();
            document.getElementById('reviewContainer').classList.remove('hidden');
        }

        function renderReview() {
            document.getElementById('draftCount').innerText = currentDraft.length;
            document.getElementById('draftList').innerHTML = currentDraft.map((q, i) => `
                <div class="review-item">
                    <div>
                        <span style="font-weight:bold; color:#666;">#${i+1}</span> 
                        ${q.text.substring(0, 80)}...
                    </div>
                    <button class="btn-danger btn-sm" onclick="removeFromDraft(${i})">Remove</button>
                </div>
            `).join('');
        }

        function removeFromDraft(index) {
            currentDraft.splice(index, 1);
            renderReview();
        }

        async function publishFinal() {
            const subj = document.getElementById('draftSubj').value;
            const cls = document.getElementById('draftClass').value;
            const dur = document.getElementById('draftTime').value;

            if(!subj || !cls) { alert("Subject and Class are required to publish."); return; }
            if(currentDraft.length === 0) { alert("Draft is empty!"); return; }

            const paper = { subject: subj, classGrade: cls, duration: dur, questions: currentDraft };

            await fetch(API + '/papers', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(paper)
            });

            alert(`✅ Exam Published Successfully!\nQuestions: ${currentDraft.length}\nSubject: ${subj}\nClass: ${cls}`);
            document.getElementById('reviewContainer').classList.add('hidden');
            currentDraft = []; // Clear draft
        }

        // --- BANK MANAGEMENT ---
        async function bulkImport() {
            const file = document.getElementById('fileImport').files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = async (e) => {
                const res = await fetch(API+'/bank/bulk', {method:'POST', headers:{'Content-Type':'application/json'}, body:e.target.result});
                alert(`Imported ${(await res.json()).count} questions`);
            };
            r.readAsText(file);
        }

        async function addQuestion() {
            const q = {
                text: document.getElementById('qText').value,
                options: {
                    A: document.getElementById('optA').value, B: document.getElementById('optB').value,
                    C: document.getElementById('optC').value, D: document.getElementById('optD').value
                },
                correct: document.getElementById('qCorrect').value,
                // Assign subject from filter box or default
                subject: document.getElementById('draftSubj').value || "General" 
            };
            await fetch(API+'/bank/bulk', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify([q])});
            alert("Added!");
            document.getElementById('manualEntry').classList.add('hidden');
        }

        // --- EXAM FLOW ---
        async function findPaper(cls, subj) {
            const res = await fetch(API + '/papers');
            const papers = await res.json();
            const match = papers.find(p => p.classGrade.toLowerCase() === cls.toLowerCase() && p.subject.toLowerCase() === subj.toLowerCase());

            if(match) {
                examData = match;
                document.getElementById('preTitle').innerText = match.subject;
                document.getElementById('preMeta').innerText = `Class: ${match.classGrade} | Time: ${match.duration} Min`;
                showView('viewPreview');
            } else { alert("Exam Not Found"); location.reload(); }
        }

        function startExam() {
            showView('viewExam');
            // Randomize questions for this specific student session
            activeQs = examData.questions.sort(() => Math.random() - 0.5);
            
            document.getElementById('examContainer').innerHTML = activeQs.map((q, i) => `
                <div class="card">
                    <p><strong>Q${i+1}:</strong> ${q.text}</p>
                    ${['A','B','C','D'].sort(()=>Math.random()-0.5).map(k => `
                        <label style="display:block; padding:5px;"><input type="radio" name="q${i}" value="${k}"> ${q.options[k]}</label>
                    `).join('')}
                </div>
            `).join('');

            let s = examData.duration * 60;
            timerInt = setInterval(() => {
                s--;
                document.getElementById('examTimer').innerText = `Time: ${Math.floor(s/60)}:${s%60}`;
                if(s<=0) { clearInterval(timerInt); submitExam(); }
            }, 1000);
        }

        async function submitExam() {
            clearInterval(timerInt);
            let score = 0;
            activeQs.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                if(sel && sel.value === q.correct) score++;
            });
            await fetch(API+'/submit', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({studentName:userCtx.username, subject:examData.subject, score:`${score}/${activeQs.length}`})});
            alert(`Submitted! Score: ${score}`); location.reload();
        }

        // --- HELPERS ---
        function showView(v) { ['viewLogin','viewAdmin','viewPreview','viewExam'].forEach(x => document.getElementById(x).classList.add('hidden')); document.getElementById(v).classList.remove('hidden'); }
        function switchTab(t) { ['tabCreate','tabStudents','tabResults'].forEach(x => document.getElementById(x).classList.add('hidden')); document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden'); if(t==='students') loadUsers(); if(t==='results') loadResults(); }
        async function loadUsers() { const d = await (await fetch(API+'/users')).json(); document.getElementById('studentList').innerHTML = d.map(u => `<div>${u.username} <button onclick="delUser('${u.username}')" class="btn-danger btn-sm">X</button></div>`).join(''); }
        async function addStudent() { await fetch(API+'/users', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:document.getElementById('newUid').value, password:document.getElementById('newPass').value})}); loadUsers(); }
        async function delUser(id) { await fetch(API+'/users/'+id, {method:'DELETE'}); loadUsers(); }
        async function loadResults() { const d = await (await fetch(API+'/results')).json(); document.getElementById('resultList').innerHTML = d.map(r => `<tr><td>${r.studentName}</td><td>${r.subject}</td><td>${r.score}</td><td>${r.timestamp}</td></tr>`).join(''); }
    </script>
</body>
</html>
