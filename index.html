<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viswam Edutech | IIT-NEET Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #2d7a8a; --bg: #f0f2f5; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .hidden { display: none !important; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* HEADER */
        .title-bar { 
            background: white; padding: 15px 30px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-bottom: 4px solid var(--primary);
        }
        .logo-box img { max-height: 65px; }
        .title-text { text-align: center; flex: 1; color: var(--primary); }

        /* CARDS & INPUTS */
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-top: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        /* PREVIEW & EXAM */
        .preview-box { text-align: center; border: 2px dashed var(--primary); padding: 40px; border-radius: 15px; background: #f8fbff; }
        .preview-title { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
        .preview-meta { font-size: 1.2rem; color: #666; margin-bottom: 30px; }
        
        .timer-bar { background: #2c3e50; color: white; text-align: center; padding: 15px; font-weight: bold; border-radius: 8px; position: sticky; top: 0; z-index: 100; font-size: 1.2rem; }
        .option-row { display: block; padding: 15px; border: 1px solid #eee; border-radius: 8px; margin: 10px 0; cursor: pointer; transition: 0.2s; }
        .option-row:hover { background: #eef; border-color: var(--primary); }
    </style>
</head>
<body>

    <header class="title-bar no-print">
        <div class="logo-box"><img src="iitneet.png" alt="IIT-NEET"></div>
        <div class="title-text">
            <h1 style="margin:0;">IIT-NEET Exam Portal</h1>
            <p style="margin:5px 0 0 0;">Viswam Edutech Curriculum</p>
        </div>
        <div class="logo-box"><img src="viswam.png" alt="Viswam"></div>
    </header>

    <div id="loginView" class="container" style="max-width: 450px; margin-top: 50px;">
        <div class="card">
            <h2 style="text-align:center; color: var(--primary); margin-bottom: 25px;">Student / Admin Login</h2>
            <form onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label>User ID</label>
                    <input type="text" id="username" placeholder="Enter ID (e.g., admin or S101)" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter Password" required>
                </div>
                
                <div id="studentFilters">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Target Class</label>
                            <input type="text" id="loginClass" placeholder="e.g. 10th">
                        </div>
                        <div class="input-group">
                            <label>Target Subject</label>
                            <input type="text" id="loginSubj" placeholder="e.g. Maths">
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-primary">Access Portal</button>
            </form>
            <p id="loginErr" style="color:red; text-align:center; margin-top:15px;"></p>
        </div>
    </div>

    <div id="adminView" class="container hidden">
        <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
            <button class="btn-primary" onclick="switchTab('create')" style="width:auto">Create Exam</button>
            <button class="btn-primary" onclick="switchTab('students')" style="width:auto">Students</button>
            <button class="btn-success" onclick="switchTab('results')" style="width:auto">Results</button>
            <button class="btn-danger" onclick="location.reload()" style="width:auto">Logout</button>
        </div>

        <div id="tabCreate">
            <div class="card">
                <h3>1. Build Question Bank</h3>
                <input type="file" onchange="runOCR(this)">
                <textarea id="qText" placeholder="Question Text..." rows="3"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="optA" placeholder="Option A"> <input type="text" id="optB" placeholder="Option B">
                    <input type="text" id="optC" placeholder="Option C"> <input type="text" id="optD" placeholder="Option D">
                </div>
                <select id="qCorrect"><option value="A">Answer A</option><option value="B">Answer B</option><option value="C">Answer C</option><option value="D">Answer D</option></select>
                <button class="btn-primary" onclick="saveToBank()">Add Question</button>
                <hr>
                <h3>2. Publish Paper</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="pubSubj" placeholder="Subject Name (MUST match Login)">
                    <input type="text" id="pubClass" placeholder="Class Name (MUST match Login)">
                </div>
                <input type="number" id="pubTime" placeholder="Duration (Minutes)" value="30">
                <button class="btn-success" onclick="publishPaper()">Publish Exam Now</button>
            </div>
        </div>

        <div id="tabStudents" class="hidden"><div class="card"><h3>Student Management</h3><div id="studentList"></div></div></div>
        <div id="tabResults" class="hidden"><div class="card"><h3>Results</h3><div id="resultList"></div></div></div>
    </div>

    <div id="previewView" class="container hidden">
        <div class="card preview-box">
            <div style="margin-bottom:20px;">
                <img src="viswam.png" style="height:80px;">
            </div>
            <h1 id="preTitle" class="preview-title">Mathematics Exam</h1>
            <p id="preMeta" class="preview-meta">Class: 10th | Duration: 60 Mins | Questions: 50</p>
            
            <div style="text-align:left; background: white; padding:20px; border-radius:10px; margin-bottom:30px;">
                <strong>Instructions:</strong>
                <ul>
                    <li>The timer starts immediately after clicking "Start".</li>
                    <li>Do not switch tabs or windows (Lockdown is Active).</li>
                    <li>Ensure you are connected to the network.</li>
                </ul>
            </div>

            <button class="btn-success" onclick="launchExam()" style="width:200px; font-size:1.2rem;">START EXAM</button>
            <br><br>
            <button class="btn-danger" onclick="location.reload()" style="width:200px;">Cancel</button>
        </div>
    </div>

    <div id="examView" class="container hidden">
        <div id="timerDisplay" class="timer-bar">Time Left: --:--</div>
        <div id="questionContainer" style="margin-top:20px;"></div>
        <button class="btn-success" onclick="submitExam()" style="margin-top:30px; font-size:1.2rem;">Submit Final Paper</button>
    </div>

    <script>
        const API = '/api';
        let userCtx = {};
        let examData = {}; // Stores the loaded paper
        let timerInt;

        // --- 1. LOGIN LOGIC ---
        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const cls = document.getElementById('loginClass').value; // Get Class
            const subj = document.getElementById('loginSubj').value; // Get Subject

            // Admin Bypass
            if(u === 'admin' && p === 'Viswam@2026') {
                showView('adminView'); return;
            }

            // Verify Student
            const res = await fetch(API + '/users');
            const users = await res.json();
            const valid = users.find(x => x.username === u && x.password === p);

            if(valid) {
                userCtx = { ...valid, class: cls, subject: subj }; // Store intended class/subject
                
                // NEW: Find the specific paper immediately
                findAndLoadPaper(cls, subj);
            } else {
                document.getElementById('loginErr').innerText = "Invalid ID or Password";
            }
        }

        // --- 2. PREVIEW LOGIC (The "Missing" Feature) ---
        async function findAndLoadPaper(cls, subj) {
            const res = await fetch(API + '/papers');
            const papers = await res.json();
            
            // FILTER: Match Class AND Subject (Case insensitive)
            const match = papers.find(p => 
                p.classGrade.toLowerCase() === cls.toLowerCase() && 
                p.subject.toLowerCase() === subj.toLowerCase()
            );

            if(match) {
                examData = match; // Store loaded exam
                
                // Populate Preview Card
                document.getElementById('preTitle').innerText = `${match.subject} Examination`;
                document.getElementById('preMeta').innerText = `Class: ${match.classGrade} | Duration: ${match.duration} Mins | Questions: ${match.questions.length}`;
                
                showView('previewView'); // Show Preview Screen
            } else {
                alert(`No exam found for Subject: "${subj}" and Class: "${cls}". Please check your spelling or ask the admin.`);
                location.reload();
            }
        }

        // --- 3. EXAM ENGINE ---
        function launchExam() {
            showView('examView');
            
            // Randomize Questions
            const qs = examData.questions.sort(() => Math.random() - 0.5);
            
            document.getElementById('questionContainer').innerHTML = qs.map((q, i) => `
                <div class="card">
                    <p><strong>Q${i+1}:</strong> ${q.text}</p>
                    <div>
                        ${['A','B','C','D'].sort(() => Math.random() - 0.5).map(k => `
                            <label class="option-row">
                                <input type="radio" name="q${i}" value="${k}"> ${q.options[k]}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            startTimer(examData.duration);
        }

        function startTimer(mins) {
            let sec = mins * 60;
            timerInt = setInterval(() => {
                const m = Math.floor(sec / 60);
                const s = sec % 60;
                document.getElementById('timerDisplay').innerText = `Time Left: ${m}:${s < 10 ? '0'+s : s}`;
                if(sec-- <= 0) {
                    clearInterval(timerInt);
                    submitExam();
                }
            }, 1000);
        }

        async function submitExam() {
            clearInterval(timerInt);
            // Simple scoring for prototype
            let score = 0;
            // (Scoring logic here...)
            alert("Exam Submitted Successfully!");
            location.reload();
        }

        // --- HELPER FUNCTIONS ---
        function showView(id) {
            ['loginView', 'adminView', 'previewView', 'examView'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // --- ADMIN FUNCTIONS (Simplified for brevity) ---
        async function saveToBank() { /* logic to save to bank */ }
        async function publishPaper() {
            const paper = {
                subject: document.getElementById('pubSubj').value,
                classGrade: document.getElementById('pubClass').value,
                duration: document.getElementById('pubTime').value,
                questions: [] // Add logic to pull random questions from bank
            };
            await fetch(API + '/papers', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(paper) });
            alert("Paper Published! Students can now login with this Subject/Class.");
        }
        function switchTab(t) {
            // Tab switching logic
        }
        
        // --- OCR ---
        async function runOCR(inp) {
            const r = await Tesseract.recognize(inp.files[0], 'eng');
            document.getElementById('qText').value = r.data.text;
        }

        // Admin login check to hide student filters
        document.getElementById('username').addEventListener('input', function(e) {
            const isAdm = e.target.value.toLowerCase() === 'admin';
            document.getElementById('studentFilters').style.display = isAdm ? 'none' : 'block';
        });
    </script>
</body>
</html>
