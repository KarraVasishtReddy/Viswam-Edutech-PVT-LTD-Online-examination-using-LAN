<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viswam Edutech | IIT-NEET Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #2d7a8a;
            --primary-light: #e8f5f7;
            --bg: #f4f7f8;
            --danger: #e74c3c;
            --dark: #2c3e50;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: #333; line-height: 1.6; }
        .hidden { display: none !important; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

        /* Branded Header */
        .title-bar { 
            background: white; padding: 15px 30px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 4px solid var(--primary);
        }
        .logo-box img { max-height: 60px; object-fit: contain; }
        .title-text { text-align: center; flex: 1; color: var(--primary); }

        /* General UI Elements */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .tab-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }

        /* Student View & Proctoring */
        .timer-bar { background: var(--dark); color: white; text-align: center; padding: 12px; font-weight: bold; border-radius: 8px; position: sticky; top: 0; z-index: 100; }
        .proctor-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .violation-tag { color: var(--danger); font-weight: bold; background: #fee2e2; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--danger); }
        .progress-outer { background: #eee; height: 10px; border-radius: 5px; width: 150px; overflow: hidden; }
        .progress-inner { height: 100%; background: var(--primary); transition: 0.3s; }
        
        .option-label { display: block; padding: 12px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .option-label:hover { border-color: var(--primary); background: var(--primary-light); }
    </style>
</head>
<body>

    <header class="title-bar no-print">
        <div class="logo-box"><img src="iitneet.png" alt="IIT-NEET"></div>
        <div class="title-text">
            <h1 style="margin:0;">IIT-NEET Portal</h1>
            <p style="margin:5px 0 0 0; font-size:0.85rem;">Powered by Viswam Edutech</p>
        </div>
        <div class="logo-box"><img src="viswam.png" alt="Viswam Edutech"></div>
    </header>

    <div id="loginView" class="container" style="max-width: 400px; margin-top: 60px;">
        <div class="card">
            <h2 style="text-align:center; color: var(--primary); margin-bottom:20px;">System Login</h2>
            <form onsubmit="handleAuth(event)">
                <input type="text" id="username" placeholder="User ID" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn-primary" style="width:100%">Sign In</button>
            </form>
            <p id="err" style="color:red; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="adminView" class="container hidden">
        <div class="tab-row">
            <button class="btn-primary" onclick="switchTab('students')">Students</button>
            <button class="btn-primary" onclick="switchTab('proctor')">Live Monitor</button>
            <button class="btn-primary" onclick="switchTab('create')">Build Exam</button>
            <button class="btn-success" onclick="switchTab('results')">Gradebook</button>
            <button class="btn-danger" onclick="location.reload()">Logout</button>
        </div>

        <div id="tabProctor" class="hidden">
            <div class="card">
                <h3>Live Proctoring Dashboard</h3>
                <div id="proctorList"></div>
            </div>
        </div>

        <div id="tabStudents" class="hidden">
            <div class="card">
                <h3>Create Student Account</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input type="text" id="newUid" placeholder="Student ID">
                    <input type="password" id="newPass" placeholder="Password">
                </div>
                <button class="btn-success" onclick="addStudent()">Register Student</button>
            </div>
            <div class="card">
                <table id="userTable"><thead><tr><th>Student ID</th><th>Action</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="tabCreate" class="hidden">
            <div class="card" style="background:#fffbeb; border: 1px solid #f59e0b;">
                <h3>ðŸš€ Bulk Import (JSON File)</h3>
                <input type="file" accept=".json" onchange="bulkImport(this)">
                <div id="bulkStatus" style="margin-top:10px; font-weight:bold;"></div>
            </div>
            <div class="card">
                <h3>Question Bank Builder</h3>
                <input type="file" accept="image/*" onchange="runOCR(this)">
                <textarea id="qText" placeholder="Edit extracted text or type question..."></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="optA" placeholder="A"> <input type="text" id="optB" placeholder="B">
                    <input type="text" id="optC" placeholder="C"> <input type="text" id="optD" placeholder="D">
                </div>
                <select id="qCorrect">
                    <option value="A">A</option><option value="B">B</option>
                    <option value="C">C</option><option value="D">D</option>
                </select>
                <button class="btn-primary" onclick="saveToBank()">Save to Bank</button>
            </div>
            <div class="card">
                <h3>Publish Exam Paper</h3>
                <button class="btn-primary" onclick="loadBank()">Refresh Bank</button>
                <div id="qBankList" style="margin:15px 0; max-height:250px; overflow-y:auto; border:1px solid #eee; padding:10px;"></div>
                
                <label><strong>Exam Details:</strong></label>
                <input type="text" id="examSubj" placeholder="Subject Name (e.g., Physics)">
                <input type="text" id="examTarget" placeholder="Target Class (e.g., 10th A)">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <label><strong>Duration (Mins):</strong></label>
                        <input type="number" id="examDuration" value="60">
                    </div>
                    <div>
                        <label><strong>Question Limit:</strong></label>
                        <input type="number" id="examLimit" placeholder="Max Questions (e.g., 50)">
                    </div>
                </div>

                <button class="btn-success" onclick="publishExam()" style="width:100%; margin-top:10px;">Publish Now</button>
            </div>
        </div>

        <div id="tabResults" class="hidden">
            <div class="card"><table id="resTable"><thead><tr><th>Student</th><th>Subject</th><th>Score</th><th>Date</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="studentView" class="container hidden">
        <div id="examTimer" class="timer-bar">Time Remaining: --:--</div>
        <div id="examMain" style="margin-top:20px;"></div>
        <button id="finalSubmit" class="btn-success hidden" onclick="confirmFinish()" style="width:100%; padding:20px; font-size:1.2rem; margin-top:20px;">Finalize Submission</button>
    </div>

    <script>
        const API = '/api';
        let uCtx = {}; let examCtx = {}; let qs = []; let clock; let monitor;
        let violations = 0;

        // --- AUTHENTICATION ---
        async function handleAuth(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (u === 'admin' && p === 'Viswam@2026') {
                switchView('adminView'); switchTab('students'); return;
            }
            const res = await fetch(API + '/users');
            const users = await res.json();
            const found = users.find(x => x.username === u && x.password === p);
            if (found) {
                uCtx = found; switchView('studentView'); loadExams();
            } else { document.getElementById('err').innerText = "âŒ Access Denied"; }
        }

        // --- HEARTBEAT & PROCTORING ---
        function pulse() {
            if (!examCtx.id) return;
            const done = document.querySelectorAll('input[type="radio"]:checked').length;
            const progress = Math.round((done / qs.length) * 100) || 0;
            fetch(API + '/proctor/heartbeat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: uCtx.username,
                    subject: examCtx.subject,
                    progress: progress,
                    time: document.getElementById('examTimer').innerText,
                    alerts: violations
                })
            });
        }

        window.addEventListener('blur', () => {
            if (examCtx.id) {
                violations++;
                alert("ðŸš¨ SECURITY ALERT: Tab switching is recorded!");
                pulse();
            }
        });

        async function loadProctorData() {
            const res = await fetch(API + '/proctor/sessions');
            const data = await res.json();
            document.getElementById('proctorList').innerHTML = data.map(s => `
                <div class="proctor-item">
                    <div><strong>${s.username}</strong> (${s.subject})</div>
                    <div style="text-align:right">
                        <div>${s.time}</div>
                        <div class="progress-outer"><div class="progress-inner" style="width:${s.progress}%"></div></div>
                        ${s.alerts > 0 ? `<span class="violation-tag">Alerts: ${s.alerts}</span>` : '<span style="color:green">Active</span>'}
                    </div>
                </div>
            `).join('');
        }

        // --- ADMIN CONTROLS ---
        function switchTab(t) {
            clearInterval(monitor);
            ['tabStudents','tabCreate','tabResults','tabProctor'].forEach(x => document.getElementById(x).classList.add('hidden'));
            document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('hidden');
            if(t === 'students') loadStudents();
            if(t === 'results') loadResults();
            if(t === 'proctor') { loadProctorData(); monitor = setInterval(loadProctorData, 5000); }
        }

        async function addStudent() {
            const u = document.getElementById('newUid').value;
            const p = document.getElementById('newPass').value;
            await fetch(API + '/users', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p}) });
            loadStudents();
        }

        async function loadStudents() {
            const res = await fetch(API + '/users');
            const d = await res.json();
            document.querySelector('#userTable tbody').innerHTML = d.map(u => `<tr><td>${u.username}</td><td><button class="btn-danger" onclick="delUser('${u.username}')">Delete</button></td></tr>`).join('');
        }

        async function delUser(id) { if(confirm("Remove Student?")) { await fetch(API + '/users/' + id, {method:'DELETE'}); loadStudents(); } }

        async function runOCR(input) {
            const res = await Tesseract.recognize(input.files[0], 'eng');
            document.getElementById('qText').value = res.data.text;
        }

        async function bulkImport(input) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const res = await fetch(API + '/bank/bulk', { method: 'POST', headers: {'Content-Type':'application/json'}, body: e.target.result });
                const r = await res.json(); alert(`Successfully imported ${r.count} questions.`);
                loadBank();
            };
            reader.readAsText(input.files[0]);
        }

        async function saveToBank() {
            const q = {
                text: document.getElementById('qText').value,
                options: {A: document.getElementById('optA').value, B: document.getElementById('optB').value, C: document.getElementById('optC').value, D: document.getElementById('optD').value},
                correct: document.getElementById('qCorrect').value
            };
            await fetch(API + '/bank', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(q) });
            alert("Added to Bank");
        }

        async function loadBank() {
            const res = await fetch(API + '/bank');
            const data = await res.json();
            document.getElementById('qBankList').innerHTML = data.map(q => `<div><input type="checkbox" class="q-pick" value="${q.id}"> ${q.text.substring(0,60)}...</div>`).join('');
        }

        // --- UPDATED PUBLISH FUNCTION ---
        async function publishExam() {
            // 1. Get manually selected questions
            let ids = Array.from(document.querySelectorAll('.q-pick:checked')).map(x => parseFloat(x.value));
            const bankRes = await fetch(API + '/bank');
            const bank = await bankRes.json();
            
            let finalQuestions = bank.filter(q => ids.includes(q.id));

            // 2. Handle Question Limit (Random Selection)
            const limit = parseInt(document.getElementById('examLimit').value);
            
            // If user didn't pick specific questions, use the whole bank (or filtered view)
            if (finalQuestions.length === 0) {
                 finalQuestions = bank; 
            }

            // Shuffle and slice if a limit is set
            if (limit > 0 && finalQuestions.length > limit) {
                finalQuestions = finalQuestions.sort(() => 0.5 - Math.random()).slice(0, limit);
            }

            const exam = { 
                subject: document.getElementById('examSubj').value, 
                classGrade: document.getElementById('examTarget').value, 
                questions: finalQuestions, 
                duration: document.getElementById('examDuration').value 
            };
            
            await fetch(API + '/papers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(exam) });
            alert(`Exam Published with ${finalQuestions.length} questions!`);
        }

        // --- STUDENT ENGINE ---
        async function loadExams() {
            const res = await fetch(API + '/papers');
            const papers = await res.json();
            document.getElementById('examMain').innerHTML = papers.map(p => `
                <div class="card">
                    <h3>${p.subject}</h3>
                    <p>Questions: ${p.questions.length} | Duration: ${p.duration} mins</p>
                    <button class="btn-success" onclick='startExam(${JSON.stringify(p)})'>Start Exam</button>
                </div>
            `).join('');
        }

        function startExam(p) {
            examCtx = p;
            
            // Randomize Questions for EACH Student
            qs = p.questions.sort(() => Math.random() - 0.5);
            
            document.getElementById('examMain').innerHTML = qs.map((q, i) => `
                <div class="card">
                    <p><strong>Q${i+1}:</strong> ${q.text}</p>
                    <div style="margin-top:15px;">
                        ${['A','B','C','D'].sort(() => Math.random() - 0.5).map(k => `
                            <label class="option-label">
                                <input type="radio" name="q${i}" value="${k}" onclick="pulse()"> ${q.options[k]}
                            </label>
                        `).join('')}
                    </div>
                </div>`).join('');
            document.getElementById('finalSubmit').classList.remove('hidden');
            let t = p.duration * 60;
            clock = setInterval(() => {
                document.getElementById('examTimer').innerText = `Time Left: ${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`;
                if(t-- <= 0) { clearInterval(clock); confirmFinish(); }
            }, 1000);
            setInterval(pulse, 15000);
        }

        async function confirmFinish() {
            clearInterval(clock); let score = 0;
            qs.forEach((q, i) => { if(document.querySelector(`input[name="q${i}"]:checked`)?.value === q.correct) score++; });
            await fetch(API + '/submit', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({studentName: uCtx.username, score: `${score}/${qs.length}`, subject: examCtx.subject}) });
            
            // Certificate
            const cert = window.open('', '_blank');
            cert.document.write(`<div style="border:10px solid #2d7a8a; padding:50px; text-align:center; font-family:sans-serif;"><h1>IIT-NEET Excellence Certificate</h1><h2>${uCtx.username}</h2><p>Score: ${score}/${qs.length}</p></div>`);
            
            document.getElementById('studentView').innerHTML = `<div class="card" style="text-align:center"><h2>Submitted Successfully.</h2></div>`;
        }

        async function loadResults() {
            const res = await fetch(API + '/results');
            const d = await res.json();
            document.querySelector('#resTable tbody').innerHTML = d.map(r => `<tr><td>${r.studentName}</td><td>${r.subject}</td><td><b>${r.score}</b></td><td>${r.timestamp}</td></tr>`).join('');
        }

        function switchView(v) { ['loginView','adminView','studentView'].forEach(x => document.getElementById(x).classList.add('hidden')); document.getElementById(v).classList.remove('hidden'); }
    </script>
</body>
</html>
